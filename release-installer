#!/bin/bash
# Shared default configuration and utility functions.
source freenet-scripts-common || exit
readConfig || exit

cd $installerDir
./build-all.sh || exit
getBuildInfo
if [[ -z "$gitVersion" ]]; then echo Could not get git version; exit 1; fi
echo Version is $buildNumber
TEMPDIR=`mktemp -d`
cp $installerDir/dist/* $TEMPDIR || exit
cd $TEMPDIR
echo Copied to $TEMPDIR
echo Signing the jars
for i in $(ls -1 *jar); do jarsigner -storepass $jarsignerStorePassword $i $jarsignerAlias; done
cp *jar $installerDir/dist/
sign-installer-jars || exit
cp $installerDir/dist/*jar.sig .
(cd $installerDir/scripts/; sha1sum update.cmd > update.cmd.sha1; sha1sum update.sh > update.sh.sha1; cd $installerDir/res/; sha1sum wrapper.conf > wrapper.conf.sha1)
eval `ssh-agent -s`
ssh-add
rsync $installerDir/scripts/update.* $installerDir/res/wrapper.conf* $targetHost:/var/www/downloads/alpha/update/ || exit
cp new_installer_offline.jar new_installer_offline_${buildNumber}.jar || exit
cp new_installer_offline.jar.sig new_installer_offline_${buildNumber}.jar.sig || exit
ls -l new_installer_offline_${buildNumber}.jar
cp new_installer_offline_${buildNumber}.jar* $releaseDir || exit
rm new_installer_offline_${buildNumber}.jar new_installer_offline_${buildNumber}.jar.sig
echo Uploading to emu
rsync -v new_installer* sha1test.jar* wrapper* $targetHost:/var/www/downloads/alpha/installer/
ssh $targetHost -- "cp /var/www/downloads/alpha/installer/new_installer_offline.jar /var/www/downloads/alpha/installer/new_installer_offline_${buildNumber}.jar"
rsync -v new_installer_offline.jar.sig $targetHost:/var/www/downloads/alpha/installer/new_installer_offline_${buildNumber}.jar.sig
OLDVERSION=$[$buildNumber-5]
echo Deleting old version ${OLDVERSION}
ssh $targetHost rm /var/www/downloads/alpha/installer/new_installer_offline_${OLDVERSION}.jar
ssh $targetHost -- "cp /var/www/downloads/alpha/.registry .; cat /var/www/downloads/alpha/.registry | sed \"s/new_installer_offline.jar .*$/new_installer_offline.jar installer\/new_installer_offline_${buildNumber}.jar/\" > new-registry ; cat new-registry > /var/www/downloads/alpha/.registry"
ssh-agent -k

#!/bin/bash

# variables used by this script
# these variables are probably different for everybody
# so create $HOME/.freenetrc and override those with your desired values.

# Default path to configuration file.
configPath="$home/.freenetrc"
# What to build / release. Possible values: "build", "snapshot"
target=""
# Whether to exit before releasing.
dryRun="false"

# Path to Fred repository.
fredDir="/usr/src/cvs/eclipse-workspace/fred/"
# Target directory for generated files.
releaseDir="/usr/src/cvs/eclipse-workspace/FreenetReleased"
# Path to freenet-ext.
freenetExtPath="/usr/src/cvs/eclipse-workspace/FreenetReleased/freenet-ext.jar"
# If set, su to a user to sign the output. Leave empty to sign as the current user.
signingUser="toad"
# If "1" starts ssh agent before sending the update to the target host and stops it afterward.
useSshAgent="1"
# Hostname to send updates to.
targetHost="osprey.vm.bytemark.co.uk"
# FCP host hostname / IP.
fcpHost="127.0.0.1"
# FCP host port.
fcpPort="9481"

while :
do
    case $1 in
        --help | - | -\?)
            echo "Builds and releases a version of Fred."
            echo "Prompts for confirmation before releasing."
            echo "Configuration file is at $configPath by default."
            echo "Requires --snapshot or --build."
            echo
            echo "--config CONFIG   Path to freenetrc"
            echo "--dry-run         If present, builds packages and skips releasing."
            echo "--build           If present packages the highest-numbered build tag."
            echo "                  Builds documentation."
            echo "--snapshot        If present packages the current HEAD."
            echo "                  Outputs into a pre/ subdirectory of the release directory."
            echo "                  Skips building documentation."
            exit 0
            ;;
        --config)
            CONFIG="$2"
            shift 2
            ;;
        --dry-run)
            dryRun="true"
            shift
            ;;
        --snapshot)
            target="snapshot"
            shift
            ;;
        --build)
            target="build"
            shift
            ;;
        --) # End of all options
            shift
            break
            ;;
        -*)
            echo "Unknown option: $1"
            exit 1
            ;;
        *)  # No more options; stop parsing.
            break
            ;;
    esac
done

# override these variables, if necessary
if [ -f "$configPath" ]; then
    . "$configPath"
fi

# Target should be set.
if [[ -z "$target" ]]; then
    echo "Target not set. Please specify --build or --snapshot."
    exit 13
fi

# If releasing a snapshot it goes into the pre/ subdirectory.
if [[ "$target" = "snapshot" ]]; then
    releaseDir="$releaseDir/pre"
fi

buildDir=$(mktemp -d)
echo "Created temporary directory $buildDir."
git clone "$fredDir" "$buildDir" || exit 2
pushd "$buildDir"

# If releasing a stable build checkout the latest build tag.
if [[ "$target" = "build" ]]; then
    # Get highest-numbered build tag.
    gitVersion=$(git tag | grep '^build' | sort | tail -n1)
    # Strip "build" from the front.
    buildNumber=${gitVersion:5}
    # Strip possible leading zeros.
    buildNumber=${buildNumber#0}
    git checkout "$gitVersion" || exit 12
elif [[ "$target" = "snapshot" ]]; then
    gitVersion=$(git describe --always --abbrev=40)
else
    echo "Unrecognized internal target of \"$target\"."
    exit 14
fi

# copy freenet-ext.jar
mkdir -p lib 2>/dev/null
cp "$freenetExtPath" lib/freenet-ext.jar || exit 3
mkdir -p lib/freenet
cp lib/freenet-ext.jar lib/freenet/ || exit 4
cp "$fredDir/lib/bcprov.jar" lib/ || exit 30

# clean
ant clean || exit 5
git reset --hard || exit 6

if [[ "$target" = "build" ]]; then
    ant -f build-clean.xml || exit 16
    jarName="freenet-$gitVersion.jar"
elif [[ "$target" = "snapshot" ]]; then
# now build it (without api doc)
ant -f build-clean.xml -Ddoc.skip=true || exit 9
    jarName="freenet-$gitVersion-snapshot.jar"
else
    echo "Unrecognized internal target of \"$target\"."
    exit 15
fi

archiveName="freenet-$gitVersion-source.tar.bz2"

# move file in position
mv dist/freenet.jar "$jarName" || exit 10

# create source archive
git archive --format=tar HEAD | bzip2 -v9 > "$archiveName" || exit 11

# Generate checksums and signatures for the jar and source archive.
sha1sum "$jarName" > "$jarName.sha1"
sha1sum "$archiveName" > "$archiveName.sha1"
if [ -n "$signingUser" ]; then
    echo "Switching to signing user \"$signingUser\""
    signDir=$(mktemp -d)
    cp "$buildDir/$jarName" "$buildDir/$archiveName" "$signDir" || exit 18
    # signingUser is a top level user, so it has its own group, right?
    chgrp "$signingUser" "$signDir" || exit 19
    chmod g+rwx "$signDir" || exit 20
    chmod g+r "$signDir"/* || exit 21
    su - "$signingUser" -c "gpg --sign --detach-sign -o \"$signDir/$jarName.sig\" \"$signDir/$jarName\"; gpg --sign --detach-sign -o \"$signDir/$archiveName.sig\" \"$signDir/$archiveName\"" || exit 22
    cp "$signDir/$jarName.sig" "$signDir/$archiveName.sig" "$buildDir" || exit 23
    rm -Rf "$signDir"
else
    gpg --sign --detach-sign -o "$buildDir/$jarName.sig" "$buildDir/$jarName" || exit 17
    gpg --sign --detach-sign -o "$buildDir/$archiveName.sig" "$buildDir/$archiveName" || exit 17
fi

# make sure release directory exists
mkdir -p "$releaseDir"
# copy files and signatures to local release directory
cp "$jarName"* "$releaseDir"
cp "$archiveName"* "$releaseDir"
rm "$releaseDir/freenet.jar"
ln -s "$releaseDir/$jarName" "$releaseDir/freenet.jar"

# Localization comparison for build.
if [[ "$target" = "build" ]]; then
    newBuild="$buildNumber"
    oldBuild=$((newBuild - 1))
    echo Comparing $newBuild to $oldBuild
    for build in "$oldBuild" "$newBuld"
    do
        git checkout $(printf 'build%05d' "$build")
        cp "src/freenet/l10n/freenet.l10n.en.properties" "$build"
    done
    diffName="$oldBuild-$newBuild.diff.txt"
    diff -u0 "$oldBuild" "$newBuild" > "$diffName"
    less "$diffName"
    cp "$diffName" "$releaseDir"
fi

clean_up() {
    # Return to starting directory and remove temporary.
    popd
    rm -Rf $buildDir
}

echo "Built $gitVersion as a $target release."
if [[ "$dryRun" = "true" ]]; then
    echo "Dry run - exiting without performing release."
    clean_up
    exit 0
else
    echo -n "Perform release [y/N]?"
    read response
    if [[ $(echo "$response" | tr '[:upper:]' '[:lower:]') != "y" ]]; then
        echo "Aborting release."
        exit 0
    fi
fi

echo "Performing release."

# create and update pointer files
echo "https://downloads.freenetproject.org/alpha/$jarName" > freenet-testing-latest.jar.url
wget -O ".registry" "https://downloads.freenetproject.org/alpha/.registry" || exit 28
sed -i "s/freenet-testing-latest.jar .*$/freenet-testing-latest.jar $jarName/" .registry || exit 29

if [[ "$target" = "build" ]]; then
	sed -i "s/freenet-stable-latest.jar .*$/freenet-stable-latest.jar $jarName/" .registry || exit 31
fi

# start ssh agent and collect password
if [ "$useSshAgent" == "1" ]; then
    eval $(ssh-agent -s)
    ssh-add
fi

# upload all files
rsync -vvzP "$jarName"* freenet-testing-latest.jar.url .registry "$archiveName"* "$targetHost:/var/www/downloads/alpha/" || exit 24

# Unlike a snapshot, a new build updates the localization diff and the stable-latest.url.
if [[ "$target" = "build" ]]; then
    rsync -vz "$diffName" "$targetHost:/var/www/emu/l10n/" || exit 25
    rsync -vvzP freenet-testing-latest.jar.url "$targetHost:/var/www/downloads/alpha/freenet-stable-latest.jar.url" || exit 26
    rsync --delete -rz javadoc/* "$targetHost:/var/www/freenet-javadoc" || exit 27
fi

# shut down the ssh agent
if [ "$useSshAgent" == "1" ]; then
    ssh-agent -k
fi

# Return to starting directory and remove temporary.
clean_up

# upload snapshot binary and signature to freenet
if [[ "$target" = "snapshot" ]]; then
    echo "Inserting snapshot into Freenet."
    (
    echo ClientHello;
    echo Name=Toad-update-$gitVersion;
    echo ExpectedVersion=2;
    echo End;

    echo ClientPut;
    echo "URI=CHK@";
    echo "Identifier=$jarName";
    echo Verbosity=1023;
    echo MaxRetries=-1;
    echo UploadFrom=disk;
    echo "Filename=$releaseDir/$jarName";
    echo "TargetFilename=$jarName";
    echo Persistence=forever;
    echo PriorityClass=1;
    echo Global=true;
    echo End;

    echo ClientPut;
    echo "URI=CHK@";
    echo "Identifier=$jarName.sig";
    echo Verbosity=1023;
    echo MaxRetries=-1;
    echo UploadFrom=disk;
    echo "Filename=$releaseDir/$jarName.sig";
    echo "TargetFilename=$jarName.sig";
    echo Persistence=forever;
    echo PriorityClass=1;
    echo Global=true;
    echo End
    ) | nc "$fcpHost" "$fcpPort"
else
    echo "Not inserting build into Freenet."
fi

echo "Release complete."
